{% extends "sprints/base.html" %}

{% load i18n %}

{% block title %}editing sprint {{ sprint }}{% endblock %}

{% block nav-your-tasks %} selected{% endblock %}

{% block body %}
<div id="err" class="err invisible"></div>
<div id="sprint-tasks-table"></div>
<div id="add-task-row">
    <input type="text" size="8" name="remote_tracker_id" id="add-task-entry" {% if not sprint.is_active %}disabled="true"{% endif %}/>
    <input type="submit" value="{% trans "Add Task" %}" id="add-task-button" {% if not sprint.is_active %}disabled="true"{% endif %}/>
    <img src="{{ MEDIA_URL }}berserk/images/spinner.gif" class="invisible" id="spinner" width="16" height="16" alt="Loading" />
</div>
{% endblock %}

{% block js_onReady %}
    $('#add-task-entry').focus();

    var grid = new Ext.grid.GridPanel({
        store: new Ext.data.GroupingStore({
            url: '{% url sprints.views.sprint_my_tasks_json sprint.id %}',
            autoLoad: true,
            sortInfo: { field: 'status', direction: 'asc' },
            groupField: 'component',
            reader: new Ext.data.ArrayReader({}, [
                { name: 'id', type: 'string' },
                { name: 'title', type: 'string' },
                { name: 'component', type: 'string' },
                { name: 'status', type: 'string' },
                { name: 'estimated_hours', type: 'int' },
                { name: 'remaining_hours', type: 'int' },
            ]),
        }),
        columns: [
            { header: "Id", width: 65, dataIndex: 'id',
              summaryRenderer: function(v, params, data) {
                  return 'Total:';
              },
            },
            { header: "Title", width: 500, dataIndex: 'title', summaryType: 'count',
              summaryRenderer: function(v, params, data) {
                  return ((v === 0 || v > 1) ? v + ' Tasks' : '1 Task');
              },
            },
            { header: "Component", width: 90, dataIndex: 'component' },
            { header: "Status", width: 70, dataIndex: 'status' },
            { header: "Est", width: 35, dataIndex: 'estimated_hours', summaryType: 'sum' },
            { header: "Rem", width: 35, dataIndex: 'remaining_hours', summaryType: 'sum' },
        ],
        stripeRows: true,
        width: "100%", height: 500,
        loadMask: true,
        view: new Ext.grid.GroupingView({
            showGroupName: true, hideGroupedColumn: true
        }),
        plugins: new Ext.grid.GroupSummary(),
    });
    grid.getColumnModel().defaultSortable = true;
    grid.render('sprint-tasks-table');

    $('#add-task-button').click(function() {
        $("#err").fadeOut();
        $("#spinner").show();

        $.post('{% url sprints.views.sprint_add_json sprint.id %}',
               { remote_tracker_id: $('#add-task-entry').val() }, 
               function(data) {
                   $("#spinner").hide();
                   if (data.success) {
                       grid.getStore().reload();
                       $('#add-task-entry').val('').focus();
                   } else {
                       $("#err").html(data.err).fadeIn("slow");
                       $('#add-task-entry').focus();
                   }
               }, 'json'
        );
    });
{% endblock %}
